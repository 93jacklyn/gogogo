<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç­èª¿åº¦åŠ©æ‰‹</title>
    
    <!-- 1. æ¨£å¼èˆ‡åœ–ç¤º -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. æ ¸å¿ƒå¼•æ“ (React) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Firebase æ ¸å¿ƒ (æ”¹ç”¨ç›¸å®¹ç‰ˆ SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; -webkit-font-smoothing: antialiased; }
        .loading { display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.5rem; color: #64748b; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root">
        <div class="loading">æ­£åœ¨å•Ÿå‹•å·¥ç­ç³»çµ±...</div>
    </div>

    <script type="text/babel">
        // --- é€™è£¡å¡«å…¥ä½ çš„è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBN_fK1oEhocmRCdWy0pfnaLVbhmZQdxlM",
            authDomain: "gogo-ed64b.firebaseapp.com",
            projectId: "gogo-ed64b",
            storageBucket: "gogo-ed64b.firebasestorage.app",
            messagingSenderId: "121319123217",
            appId: "1:121319123217:web:804f0adafd61cf82bc04b0"
        };

        // åˆå§‹åŒ– Firebase (ç›¸å®¹æ¨¡å¼)
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const App = () => {
            // --- ç‹€æ…‹ ---
            const [user, setUser] = React.useState(null);
            const [projects, setProjects] = React.useState([]);
            const [assignments, setAssignments] = React.useState([]);
            const [masters, setMasters] = React.useState([]);
            const [statusMsg, setStatusMsg] = React.useState('é€£ç·šä¸­...');
            
            // ä»‹é¢ç‹€æ…‹
            const [selectedDate, setSelectedDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [view, setView] = React.useState('schedule');
            const [newProject, setNewProject] = React.useState({ name: '', region: '', note: '' });
            const [isFormOpen, setIsFormOpen] = React.useState(false);

            const defaultMasters = [
                { name: "é™³å¸«å‚…", skill: "æ°´é›»", color: "bg-blue-100 border-blue-300 text-blue-800" },
                { name: "æ—å¸«å‚…", skill: "æœ¨å·¥", color: "bg-amber-100 border-amber-300 text-amber-800" },
                { name: "å¼µå¸«å‚…", skill: "æ³¥ä½œ", color: "bg-stone-100 border-stone-300 text-stone-800" },
                { name: "ç‹å¸«å‚…", skill: "æ²¹æ¼†", color: "bg-emerald-100 border-emerald-300 text-emerald-800" },
                { name: "æå¸«å‚…", skill: "é›œé …", color: "bg-purple-100 border-purple-300 text-purple-800" }
            ];

            // --- ç™»å…¥èˆ‡è³‡æ–™ç›£è½ ---
            React.useEffect(() => {
                // åŒ¿åç™»å…¥
                auth.signInAnonymously().catch(error => {
                    console.error("ç™»å…¥éŒ¯èª¤:", error);
                    setStatusMsg("ç™»å…¥å¤±æ•—");
                });

                // ç›£è½ç™»å…¥ç‹€æ…‹
                const unsubscribeAuth = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u) {
                        setStatusMsg("é›²ç«¯å·²é€£ç·š");
                        // ç™»å…¥æˆåŠŸå¾Œï¼Œé–‹å§‹ç›£è½è³‡æ–™
                        const userPath = `users/${u.uid}`;
                        
                        // 1. ç›£è½å»ºæ¡ˆ
                        db.collection(userPath + '/projects').orderBy('createdAt', 'desc')
                          .onSnapshot(snapshot => {
                              const list = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                              setProjects(list);
                          });

                        // 2. ç›£è½æ´¾å·¥
                        db.collection(userPath + '/assignments')
                          .onSnapshot(snapshot => {
                              const list = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                              setAssignments(list);
                          });

                        // 3. ç›£è½å¸«å‚…
                        db.collection(userPath + '/masters')
                          .onSnapshot(snapshot => {
                              const list = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                              if (list.length === 0) {
                                  // åˆå§‹åŒ–é è¨­å¸«å‚…
                                  defaultMasters.forEach(m => db.collection(userPath + '/masters').add(m));
                              } else {
                                  setMasters(list.sort((a,b) => a.name.localeCompare(b.name)));
                              }
                          });
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            // --- æ“ä½œåŠŸèƒ½ ---
            const addProject = () => {
                if (!newProject.name || !user) return;
                db.collection(`users/${user.uid}/projects`).add({
                    ...newProject,
                    createdAt: Date.now()
                });
                setNewProject({ name: '', region: '', note: '' });
                setIsFormOpen(false);
            };

            const deleteProject = (id) => {
                if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
                db.doc(`users/${user.uid}/projects/${id}`).delete();
                // åˆªé™¤ç›¸é—œæ´¾å·¥
                assignments.filter(a => a.projectId === id).forEach(a => {
                    db.doc(`users/${user.uid}/assignments/${a.id}`).delete();
                });
            };

            const assign = (pid, mid) => {
                const exists = assignments.find(a => a.date === selectedDate && a.masterId === mid && a.projectId === pid);
                if (exists) return;
                db.collection(`users/${user.uid}/assignments`).add({
                    projectId: pid,
                    masterId: mid,
                    date: selectedDate
                });
            };

            const removeAssign = (aid) => {
                db.doc(`users/${user.uid}/assignments/${aid}`).delete();
            };

            const updateMaster = (id, key, val) => {
                db.doc(`users/${user.uid}/masters/${id}`).update({ [key]: val });
            };

            const getTasks = (mid) => {
                return assignments
                    .filter(a => a.date === selectedDate && a.masterId === mid)
                    .map(a => {
                        const proj = projects.find(p => p.id === a.projectId);
                        return { ...a, project: proj };
                    })
                    .filter(t => t.project);
            };

            // --- ç°¡å–®åœ–ç¤º SVG ---
            const Icons = {
                Check: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg>,
                X: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>,
                Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            };

            return (
                <div className="min-h-screen pb-20 p-4 max-w-6xl mx-auto">
                    {/* Header */}
                    <header className="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow mb-6 border border-slate-200">
                        <h1 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                            ğŸ—ï¸ å·¥ç­èª¿åº¦åŠ©æ‰‹ 
                            <span className={`text-xs px-2 py-0.5 rounded-full ${user ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{statusMsg}</span>
                        </h1>
                        <div className="flex bg-slate-100 p-1 rounded-lg mt-4 md:mt-0">
                            {['schedule:æ¯æ—¥æ’ç¨‹', 'projects:å»ºæ¡ˆç®¡ç†', 'settings:å¸«å‚…è¨­å®š'].map(v => {
                                const [key, label] = v.split(':');
                                return <button key={key} onClick={()=>setView(key)} className={`px-4 py-2 rounded-md transition-all ${view===key ? 'bg-white shadow text-slate-900 font-bold' : 'text-slate-500 hover:text-slate-900'}`}>{label}</button>
                            })}
                        </div>
                    </header>

                    {/* é é¢å…§å®¹åˆ‡æ› */}
                    {view === 'schedule' && (
                        <div className="space-y-6">
                            <div className="bg-white p-4 rounded-xl shadow border border-slate-200 flex items-center gap-4">
                                <span className="font-bold text-slate-700">ğŸ“… æ–½å·¥æ—¥æœŸï¼š</span>
                                <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="bg-slate-50 border p-2 rounded-lg font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500"/>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                {/* å·¦å´ï¼šå»ºæ¡ˆæ±  */}
                                <div className="lg:col-span-1 bg-white rounded-xl shadow border border-slate-20
