<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∑•Áè≠Ë™øÂ∫¶Âä©Êâã</title>
    
    <!-- 1. Ê®£ÂºèËàáÂúñÁ§∫ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Ê†∏ÂøÉÂºïÊìé (React) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Firebase Ê†∏ÂøÉ (ÊîπÁî®Áõ∏ÂÆπÁâà SDKÔºå‰øùË≠âÁ©©ÂÆö) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; -webkit-font-smoothing: antialiased; }
        .loading { display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.5rem; color: #64748b; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root">
        <div class="loading">Ê≠£Âú®ÂïüÂãïÂ∑•Áè≠Á≥ªÁµ±...</div>
    </div>

    <script type="text/babel">
        // --- Ë®≠ÂÆöÂçÄ ---
        const firebaseConfig = {
            apiKey: "AIzaSyBN_fK1oEhocmRCdWy0pfnaLVbhmZQdxlM",
            authDomain: "gogo-ed64b.firebaseapp.com",
            projectId: "gogo-ed64b",
            storageBucket: "gogo-ed64b.firebasestorage.app",
            messagingSenderId: "121319123217",
            appId: "1:121319123217:web:804f0adafd61cf82bc04b0"
        };

        // ÂàùÂßãÂåñ Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        const App = () => {
            // --- ÁãÄÊÖãËÆäÊï∏ ---
            const [user, setUser] = React.useState(null);
            const [projects, setProjects] = React.useState([]);
            const [assignments, setAssignments] = React.useState([]);
            const [masters, setMasters] = React.useState([]);
            const [statusMsg, setStatusMsg] = React.useState('ÈÄ£Á∑ö‰∏≠...');
            
            // ‰ªãÈù¢ÊéßÂà∂
            const [selectedDate, setSelectedDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [view, setView] = React.useState('schedule');
            const [newProject, setNewProject] = React.useState({ name: '', region: '', note: '' });
            const [isFormOpen, setIsFormOpen] = React.useState(false);

            // È†êË®≠Â∏´ÂÇÖË≥áÊñô
            const defaultMasters = [
                { name: "Èô≥Â∏´ÂÇÖ", skill: "Ê∞¥Èõª", color: "bg-blue-100 border-blue-300 text-blue-800" },
                { name: "ÊûóÂ∏´ÂÇÖ", skill: "Êú®Â∑•", color: "bg-amber-100 border-amber-300 text-amber-800" },
                { name: "ÂºµÂ∏´ÂÇÖ", skill: "Ê≥•‰Ωú", color: "bg-stone-100 border-stone-300 text-stone-800" },
                { name: "ÁéãÂ∏´ÂÇÖ", skill: "Ê≤πÊºÜ", color: "bg-emerald-100 border-emerald-300 text-emerald-800" },
                { name: "ÊùéÂ∏´ÂÇÖ", skill: "ÈõúÈ†Ö", color: "bg-purple-100 border-purple-300 text-purple-800" }
            ];

            // --- 1. ÁôªÂÖ•ËàáÈÄ£Á∑ö ---
            React.useEffect(() => {
                auth.signInAnonymously().catch(error => {
                    console.error("ÁôªÂÖ•ÈåØË™§:", error);
                    setStatusMsg("ÁôªÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑Ø");
                });

                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u) {
                        setStatusMsg("Èõ≤Á´ØÂ∑≤ÈÄ£Á∑ö");
                        const userPath = `users/${u.uid}`;
                        
                        // Áõ£ËÅΩÂª∫Ê°à
                        db.collection(userPath + '/projects').orderBy('createdAt', 'desc')
                          .onSnapshot(snapshot => {
                              const list = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                              setProjects(list);
                          });

                        // Áõ£ËÅΩÊ¥æÂ∑•
                        db.collection(userPath + '/assignments')
                          .onSnapshot(snapshot => {
                              const list = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                              setAssignments(list);
                          });

                        // Áõ£ËÅΩÂ∏´ÂÇÖ
                        db.collection(userPath + '/masters')
                          .onSnapshot(snapshot => {
                              const list = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                              if (list.length === 0) {
                                  defaultMasters.forEach(m => db.collection(userPath + '/masters').add(m));
                              } else {
                                  setMasters(list.sort((a,b) => a.name.localeCompare(b.name)));
                              }
                          });
                    }
                });
                return () => unsubscribe();
            }, []);

            // --- 2. Ë≥áÊñôÊìç‰ΩúÂäüËÉΩ ---
            const addProject = () => {
                if (!newProject.name || !user) return;
                db.collection(`users/${user.uid}/projects`).add({
                    ...newProject,
                    createdAt: Date.now()
                });
                setNewProject({ name: '', region: '', note: '' });
                setIsFormOpen(false);
            };

            const deleteProject = (id) => {
                if (!confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÂóéÔºü")) return;
                db.doc(`users/${user.uid}/projects/${id}`).delete();
                assignments.filter(a => a.projectId === id).forEach(a => {
                    db.doc(`users/${user.uid}/assignments/${a.id}`).delete();
                });
            };

            const assign = (pid, mid) => {
                const exists = assignments.find(a => a.date === selectedDate && a.masterId === mid && a.projectId === pid);
                if (exists) return;
                db.collection(`users/${user.uid}/assignments`).add({
                    projectId: pid,
                    masterId: mid,
                    date: selectedDate
                });
            };

            const removeAssign = (aid) => {
                db.doc(`users/${user.uid}/assignments/${aid}`).delete();
            };

            const updateMaster = (id, key, val) => {
                db.doc(`users/${user.uid}/masters/${id}`).update({ [key]: val });
            };

            const getTasks = (mid) => {
                return assignments
                    .filter(a => a.date === selectedDate && a.masterId === mid)
                    .map(a => {
                        const proj = projects.find(p => p.id === a.projectId);
                        return { ...a, project: proj };
                    })
                    .filter(t => t.project);
            };

            // --- 3. ÂúñÁ§∫ÂÖÉ‰ª∂ ---
            const Icons = {
                Check: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg>,
                X: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>,
                Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            };

            // --- 4. Áï´Èù¢Ê∏≤Êüì ---
            return (
                <div className="min-h-screen pb-20 p-4 max-w-6xl mx-auto">
                    {/* È†ÅÈ¶ñ */}
                    <header className="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow mb-6 border border-slate-200">
                        <h1 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                            üèóÔ∏è Â∑•Áè≠Ë™øÂ∫¶Âä©Êâã 
                            <span className={`text-xs px-2 py-0.5 rounded-full ${user ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{statusMsg}</span>
                        </h1>
                        <div className="flex bg-slate-100 p-1 rounded-lg mt-4 md:mt-0">
                            {['schedule:ÊéíÁ®ã', 'projects:Âª∫Ê°à', 'settings:Â∏´ÂÇÖ'].map(v => {
                                const [key, label] = v.split(':');
                                return <button key={key} onClick={()=>setView(key)} className={`px-4 py-2 rounded-md transition-all ${view===key ? 'bg-white shadow text-slate-900 font-bold' : 'text-slate-500 hover:text-slate-900'}`}>{label}</button>
                            })}
                        </div>
                    </header>

                    {/* È†ÅÈù¢ÔºöÊØèÊó•ÊéíÁ®ã */}
                    {view === 'schedule' && (
                        <div className="space-y-6">
                            <div className="bg-white p-4 rounded-xl shadow border border-slate-200 flex items-center gap-4">
                                <span className="font-bold text-slate-700">üìÖ ÊñΩÂ∑•Êó•ÊúüÔºö</span>
                                <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="bg-slate-50 border p-2 rounded-lg font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500"/>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                {/* Âª∫Ê°àÂàóË°® */}
                                <div className="lg:col-span-1 bg-white rounded-xl shadow border border-slate-200 h-[600px] flex flex-col">
                                    <div className="p-4 border-b bg-slate-50 rounded-t-xl font-bold text-slate-700">üìã ÂæÖÊ¥æÂ∑•Âª∫Ê°à</div>
                                    <div className="overflow-y-auto p-3 space-y-3 flex-1">
                                        {projects.length === 0 && <div className="text-center text-slate-400 py-10">Â∞öÁÑ°Âª∫Ê°àÔºåË´ãÂà∞„ÄåÂª∫Ê°à„ÄçÂàÜÈ†ÅÊñ∞Â¢û</div>}
                                        {projects.map(p => (
                                            <div key={p.id} className="border rounded-lg p-3 hover:shadow-md transition-all bg-white">
                                                <div className="flex justify-between font-bold text-slate-800 mb-1">
                                                    {p.name} <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500 border">{p.region}</span>
                                                </div>
                                                <div className="text-sm text-slate-500 mb-3">{p.note || 'ÁÑ°ÂÇôË®ª'}</div>
                                                <div className="flex gap-1 border-t pt-2">
                                                    {masters.map(m => {
                                                        const isAssigned = assignments.some(a => a.projectId===p.id && a.masterId===m.id && a.date===selectedDate);
                                                        return (
                                                            <button key={m.id} onClick={()=>assign(p.id, m.id)} disabled={isAssigned} 
                                                                className={`flex-1 py-1 rounded text-xs font-bold transition-colors ${isAssigned ? 'bg-green-500 text-white cursor-default' : 'bg-slate-100 hover:bg-blue-600 hover:text-white text-slate-600'}`}>
                                                                {isAssigned ? <Icons.Check/> : m.name[0]}
                                                            </button>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Â∏´ÂÇÖË°åÁ®ãË°® */}
                                <div className="lg:col-span-2 overflow-x-auto pb-4">
                                    <div className="flex gap-4 min-w-[700px]">
                                        {masters.map(m => {
                                            const tasks = getTasks(m.id);
                                            const regions = [...new Set(tasks.map(t => t.project.region))];
                                            return (
                                                <div key={m.id} className="flex-1 min-w-[160px] bg-white rounded-xl shadow border border-slate-200 h-[600px] flex flex-col">
                                                    <div className={`p-3 border-b-2 rounded-t-xl ${m.color.split(' ')[0]} bg-opacity-20 ${m.color.replace('text-', 'border-').split(' ')[1]}`}>
                                                        <div className="font-bold text-slate-800 flex justify-between">{m.name} <span className="text-xs font-normal bg-white px-1 rounded shadow-sm">{m.skill}</span></div>
                                                        <div className="flex flex-wrap gap-1 mt-1">
                                                            {regions.map(r => <span key={r} className="text-[10px] bg-white border px-1 rounded">üìç{r}</span>)}
                                                        </div>
                                                    </div>
                                                    <div className="p-2 space-y-2 overflow-y-auto flex-1 bg-slate-50">
                                                        {tasks.length === 0 && <div className="text-center text-slate-300 text-xs py-4">Êú¨Êó•ÁÑ°Ë°åÁ®ã</div>}
                                                        {tasks.map(t => (
                                                            <div key={t.id} className="bg-white p-2 rounded border shadow-sm relative group">
                                                                <div className="flex justify-between text-xs text-slate-400 mb-1">
                                                                    <span>{t.project.region}</span>
                                                                    <button onClick={()=>removeAssign(t.id)} className="text-red-400 hover:text-red-600"><Icons.X/></button>
                                                                </div>
                                                                <div className="font-bold text-slate-800 text-sm">{t.project.name}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* È†ÅÈù¢ÔºöÂª∫Ê°àÁÆ°ÁêÜ */}
                    {view === 'projects' && (
                        <div className="bg-white rounded-xl shadow border border-slate-200 min-h-[500px]">
                            <div className="p-6 border-b flex justify-between items-center">
                                <h2 className="text-xl font-bold text-slate-800">üìÇ Âª∫Ê°àË≥áÊñôÂ∫´</h2>
                                <button onClick={()=>setIsFormOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow-sm">Ôºã Êñ∞Â¢ûÂª∫Ê°à</button>
                            </div>
                            
                            {isFormOpen && (
                                <div className="p-6 bg-blue-50 border-b border-blue-100">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <input placeholder="Âª∫Ê°àÂêçÁ®±" className="p-2 border rounded" value={newProject.name} onChange={e=>setNewProject({...newProject, name:e.target.value})}/>
                                        <input placeholder="ÂçÄÂüü (‰æãÂ¶Ç: ÊùøÊ©ã)" className="p-2 border rounded" value={newProject.region} onChange={e=>setNewProject({...newProject, region:e.target.value})}/>
                                        <input placeholder="ÂÇôË®ª" className="p-2 border rounded" value={newProject.note} onChange={e=>setNewProject({...newProject, note:e.target.value})}/>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={addProject} className="bg-blue-600 text-white px-6 py-2 rounded">ÂÑ≤Â≠ò</button>
                                        <button onClick={()=>setIsFormOpen(false)} className="bg-slate-200 text-slate-700 px-6 py-2 rounded">ÂèñÊ∂à</button>
                                    </div>
                                </div>
                            )}

                            <div className="p-6">
                                <table className="w-full text-left">
                                    <thead><tr className="bg-slate-50 text-slate-600 border-b"><th className="p-3">ÂçÄÂüü</th><th className="p-3">ÂêçÁ®±</th><th className="p-3">ÂÇôË®ª</th><th className="p-3 text-right">Âà™Èô§</th></tr></thead>
                                    <tbody>
                                        {projects.map(p => (
                                            <tr key={p.id} className="border-b hover:bg-slate-50">
                                                <td className="p-3"><span className="border bg-white px-2 py-1 rounded text-xs">{p.region}</span></td>
                                                <td className="p-3 font-bold text-slate-800">{p.name}</td>
                                                <td className="p-3 text-slate-500">{p.note}</td>
                                                <td className="p-3 text-right"><button onClick={()=>deleteProject(p.id)} className="text-red-400 hover:text-red-600 p-2"><Icons.Trash/></button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* È†ÅÈù¢ÔºöÂ∏´ÂÇÖË®≠ÂÆö */}
                    {view === 'settings' && (
                        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow border border-slate-200 p-6">
                            <h2 className="text-xl font-bold mb-6">üë∑ Â∏´ÂÇÖË≥áÊñôË®≠ÂÆö</h2>
                            <div className="space-y-4">
                                {masters.map(m => (
                                    <div key={m.id} className="flex gap-4 items-center p-4 bg-slate-50 rounded border">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${m.color.split(' ')[0]} ${m.color.split(' ')[2]}`}>{m.name[0]}</div>
                                        <div className="flex-1 grid grid-cols-2 gap-4">
                                            <div><label className="text-xs text-slate-500">ÂßìÂêç</label><input className="w-full p-2 border rounded" value={m.name} onChange={e=>updateMaster(m.id, 'name', e.target.value)}/></div>
                                            <div><label className="text-xs text-slate-500">Â∞àÈï∑</label><input className="w-full p-2 border rounded" value={m.skill} onChange={e=>updateMaster(m.id, 'skill', e.target.value)}/></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
