<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰è£æ’ç¨‹ (æ™ºæ…§é–å®šç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', "Microsoft JhengHei", sans-serif; 
            -webkit-font-smoothing: antialiased; 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .loading { display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.5rem; color: #64748b; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        input:focus, textarea:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .card-anim { 
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            transition: all 0.2s;
        }
        
        .card-anim:hover { transform: translateY(-2px); }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .nav-glow { box-shadow: 0 4px 15px -3px rgba(37, 99, 235, 0.2); }
        
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
    </style>
</head>
<body class="text-slate-900 min-h-screen">
    <div id="root">
        <div class="loading">æ­£åœ¨å•Ÿå‹•é›²ç«¯ç³»çµ±...</div>
    </div>

    <script type="text/babel">
        // --- Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBN_fK1oEhocmRCdWy0pfnaLVbhmZQdxlM",
            authDomain: "gogo-ed64b.firebaseapp.com",
            projectId: "gogo-ed64b",
            storageBucket: "gogo-ed64b.firebasestorage.app",
            messagingSenderId: "121319123217",
            appId: "1:121319123217:web:804f0adafd61cf82bc04b0"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const SHARED_PATH = 'company_data/shared_schedule';

        const getRegionStyles = (region) => {
            if (!region || region === 'æœªåˆ†é¡') return "bg-slate-100 text-slate-600 border-slate-200";
            const hash = region.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const palettes = [
                "bg-blue-50 text-blue-700 border-blue-200",
                "bg-rose-50 text-rose-700 border-rose-200",
                "bg-amber-50 text-amber-700 border-amber-200",
                "bg-emerald-50 text-emerald-700 border-emerald-200",
                "bg-indigo-50 text-indigo-700 border-indigo-200",
                "bg-cyan-50 text-cyan-700 border-cyan-200",
                "bg-fuchsia-50 text-fuchsia-700 border-fuchsia-200",
                "bg-orange-50 text-orange-700 border-orange-200",
                "bg-violet-50 text-violet-700 border-violet-200"
            ];
            return palettes[hash % palettes.length];
        };

        const EditableInput = ({ value, onSave, className, placeholder, type="text" }) => {
            const [localValue, setLocalValue] = React.useState(value || '');
            React.useEffect(() => { setLocalValue(value || ''); }, [value]);
            const handleBlur = () => { if (localValue !== value) onSave(localValue); };
            const handleKeyDown = (e) => { if (e.key === 'Enter') handleBlur(); };

            return (
                <input 
                    type={type}
                    className={`transition-all duration-200 ${className}`} 
                    value={localValue} 
                    onChange={e => setLocalValue(e.target.value)} 
                    onBlur={handleBlur}
                    onKeyDown={handleKeyDown}
                    placeholder={placeholder} 
                />
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [projects, setProjects] = React.useState([]);
            const [assignments, setAssignments] = React.useState([]);
            const [masters, setMasters] = React.useState([]);
            const [statusMsg, setStatusMsg] = React.useState('é€£ç·šä¸­...');
            const [selectedDate, setSelectedDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [view, setView] = React.useState('schedule');
            const [masterMode, setMasterMode] = React.useState(null);

            const [importText, setImportText] = React.useState('');
            const [parsedTasks, setParsedTasks] = React.useState([]);
            const [isProcessing, setIsProcessing] = React.useState(false);
            const [replanExisting, setReplanExisting] = React.useState(false);
            
            const [newProject, setNewProject] = React.useState({ name: '', region: '', address: '', note: '' });
            const [isFormOpen, setIsFormOpen] = React.useState(false);

            React.useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const mName = urlParams.get('m');
                if (mName) {
                    setMasterMode(mName);
                    setView('masterView');
                }

                auth.signInAnonymously().catch(e => setStatusMsg("é€£ç·šå¤±æ•—"));
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u) {
                        setStatusMsg(mName ? `ğŸ‘· ${mName}` : "ğŸŸ¢ ç®¡ç†å“¡");
                        db.collection(SHARED_PATH + '/projects').onSnapshot(s => setProjects(s.docs.map(d => ({id: d.id, ...d.data()}))));
                        db.collection(SHARED_PATH + '/assignments').onSnapshot(s => setAssignments(s.docs.map(d => ({id: d.id, ...d.data()}))));
                        db.collection(SHARED_PATH + '/masters').onSnapshot(s => {
                            const list = s.docs.map(d => ({id: d.id, ...d.data()}));
                            if (list.length === 0) {
                                [
                                    { name: "é™³å¸«å‚…", skill: "æ°´é›»", color: "bg-blue-500 border-blue-600 text-white" },
                                    { name: "æ—å¸«å‚…", skill: "æœ¨å·¥", color: "bg-amber-500 border-amber-600 text-white" },
                                    { name: "å¼µå¸«å‚…", skill: "æ³¥ä½œ", color: "bg-stone-500 border-stone-600 text-white" },
                                    { name: "ç‹å¸«å‚…", skill: "æ²¹æ¼†", color: "bg-emerald-500 border-emerald-600 text-white" },
                                    { name: "æå¸«å‚…", skill: "é›œé …", color: "bg-violet-500 border-violet-600 text-white" }
                                ].forEach(m => db.collection(SHARED_PATH + '/masters').add(m));
                            } else {
                                setMasters(list.sort((a,b) => a.name.localeCompare(b.name)));
                            }
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            const updateProject = (id, key, val) => db.doc(`${SHARED_PATH}/projects/${id}`).update({ [key]: val });
            const deleteProject = (id) => {
                if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
                db.doc(`${SHARED_PATH}/projects/${id}`).delete();
                assignments.filter(a => a.projectId === id).forEach(a => db.doc(`${SHARED_PATH}/assignments/${a.id}`).delete());
            };
            const addProject = () => {
                if (!newProject.name) return;
                db.collection(`${SHARED_PATH}/projects`).add({ ...newProject, createdAt: Date.now() });
                setNewProject({ name: '', region: '', address: '', note: '' });
                setIsFormOpen(false);
            };
            const assign = (pid, mid) => {
                const exists = assignments.find(a => a.date === selectedDate && a.masterId === mid && a.projectId === pid);
                if (exists) return;
                db.collection(`${SHARED_PATH}/assignments`).add({ projectId: pid, masterId: mid, date: selectedDate, period: 'å…¨å¤©', isFixed: false });
            };
            const removeAssign = (aid) => db.doc(`${SHARED_PATH}/assignments/${aid}`).delete();
            const updateMaster = (id, key, val) => db.doc(`${SHARED_PATH}/masters/${id}`).update({ [key]: val });
            
            // ğŸŸ¢ åˆ‡æ›é–å®šç‹€æ…‹
            const toggleLock = (aid, currentStatus) => {
                db.doc(`${SHARED_PATH}/assignments/${aid}`).update({ isFixed: !currentStatus });
            };

            const getTasks = (mid, date = selectedDate) => assignments
                .filter(a => a.date === date && a.masterId === mid)
                .map(a => ({ ...a, project: projects.find(p => p.id === a.projectId) }))
                .filter(t => t.project)
                .sort((a, b) => (a.project.region || '').localeCompare(b.project.region || ''));

            const openMapRoute = (mId) => {
                const tasks = getTasks(mId);
                if (tasks.length === 0) return alert("ä»Šå¤©æ²’æœ‰è¡Œç¨‹");
                const dests = tasks.map(t => encodeURIComponent(t.project.address || `${t.project.region} ${t.project.name}`));
                window.open(`https://www.google.com/maps/dir/${dests.join('/')}`, '_blank');
            };

            const copyShareLink = (mName) => {
                const baseUrl = window.location.href.split('?')[0];
                const shareUrl = `${baseUrl}?m=${encodeURIComponent(mName)}`;
                const el = document.createElement('textarea');
                el.value = shareUrl;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                alert(`å·²è¤‡è£½ ${mName} çš„å°ˆå±¬é€£çµã€‚`);
            };

            const parseTasks = () => {
                const lines = importText.split('\n').filter(l => l.trim());
                const tasks = lines.map(line => {
                    const parts = line.split(/[,ï¼Œ\t]+/).map(p => p.trim());
                    let name = parts[0] || 'æœªå‘½å';
                    let region = 'æœªåˆ†é¡';
                    let address = '';
                    let note = line;
                    let targetMaster = null;

                    if (parts.length >= 2) {
                        if (parts[1].length < 6) { region = parts[1]; if (parts[2]) address = parts[2]; }
                        else { address = parts[1]; }
                    }
                    const distMatch = line.match(/(\w+[å¸‚ç¸£])?(\w+[å€é„‰é®å¸‚])/);
                    if (distMatch) region = distMatch[2];
                    
                    masters.forEach(m => { if(line.includes(m.name)) targetMaster = m; });
                    return { name, region, address, note, targetMaster };
                });
                setParsedTasks(tasks);
            };

            // ğŸŸ¢ æ™ºæ…§æ’ç¨‹é‚è¼¯ (æ›´æ–°ç‰ˆï¼šæ”¯æ´é–å®šæ’å–®)
            const executeSchedule = async () => {
                if (replanExisting && !confirm("ç¢ºå®šè¦åŸ·è¡Œå…¨åŸŸé‡æ’ï¼Ÿ\nâš ï¸ ç³»çµ±æœƒä¿ç•™ã€Œå·²é–å®šã€çš„è¡Œç¨‹ï¼Œä½†æœƒæ¸…é™¤ä¸¦é‡æ–°å®‰æ’å…¶ä»–æœªä¾†è¡Œç¨‹ã€‚")) return;
                setIsProcessing(true);

                const tasksToAssign = [];
                for (const t of parsedTasks) {
                    const doc = await db.collection(SHARED_PATH + '/projects').add({
                        ...t, createdAt: Date.now()
                    });
                    tasksToAssign.push({
                        projectId: doc.id,
                        region: t.region,
                        masterId: t.targetMaster ? t.targetMaster.id : null
                    });
                }

                let pool = [...tasksToAssign];
                
                if (replanExisting) {
                    // ğŸŸ¢ é—œéµä¿®æ­£ï¼šåªæŠ“å–ã€Œæœªä¾†ã€ä¸”ã€Œæœªé–å®šã€çš„è¡Œç¨‹ä¾†é‡æ’
                    const futureToReplan = assignments.filter(a => a.date >= selectedDate && !a.isFixed);
                    
                    for (const a of futureToReplan) {
                        await db.doc(`${SHARED_PATH}/assignments/${a.id}`).delete();
                        const p = projects.find(proj => proj.id === a.projectId);
                        if (p) pool.push({ projectId: a.projectId, region: p.region, masterId: a.masterId });
                    }
                }

                const masterDayStatus = {}; 
                
                // ğŸŸ¢ é—œéµä¿®æ­£ï¼šåˆå§‹åŒ–ç‹€æ…‹æ™‚ï¼Œè¦åŒ…å«ã€Œéå»çš„ã€ä»¥åŠã€Œæœªä¾†å·²é–å®šã€çš„è¡Œç¨‹
                // é€™æ¨£ç³»çµ±æ‰çŸ¥é“é‚£å¤©å·²ç¶“æœ‰æ€¥ä»¶æ’å–®äº†ï¼Œä¸èƒ½å†å¡å¤ªå¤š
                const existing = replanExisting 
                    ? assignments.filter(a => a.date < selectedDate || (a.date >= selectedDate && a.isFixed)) 
                    : assignments;

                existing.forEach(a => {
                    if (!masterDayStatus[a.masterId]) masterDayStatus[a.masterId] = {};
                    if (!masterDayStatus[a.masterId][a.date]) masterDayStatus[a.masterId][a.date] = { count: 0, regions: new Set() };
                    masterDayStatus[a.masterId][a.date].count++;
                    const proj = projects.find(p => p.id === a.projectId);
                    if (proj) masterDayStatus[a.masterId][a.date].regions.add(proj.region);
                });

                pool.sort((a,b) => a.region.localeCompare(b.region));

                for (const task of pool) {
                    let bestDate = null;
                    let bestMasterId = task.masterId;
                    let maxScore = -Infinity;
                    const potentialMasters = bestMasterId ? [masters.find(m => m.id === bestMasterId)] : masters;
                    
                    for (const m of potentialMasters) {
                        if (!m) continue;
                        for (let i = 0; i < 30; i++) {
                            const d = new Date(selectedDate);
                            d.setDate(d.getDate() + i);
                            const dStr = d.toISOString().split('T')[0];
                            if (!masterDayStatus[m.id]) masterDayStatus[m.id] = {};
                            const day = masterDayStatus[m.id][dStr] || { count: 0, regions: new Set() };
                            if (day.count >= 3) continue;
                            let score = 1000;
                            if (day.regions.has(task.region)) score += 5000; 
                            else if (day.count === 0) score += 500;
                            score -= i * 50;
                            if (score > maxScore) { maxScore = score; bestDate = dStr; bestMasterId = m.id; }
                        }
                    }

                    if (bestDate && bestMasterId) {
                        if (!masterDayStatus[bestMasterId][bestDate]) masterDayStatus[bestMasterId][bestDate] = { count: 0, regions: new Set() };
                        const targetDay = masterDayStatus[bestMasterId][bestDate];
                        const periods = ['ä¸Šåˆ', 'ä¸‹åˆ', 'å‚æ™š'];
                        const period = periods[targetDay.count] || 'å…¨å¤©';
                        await db.collection(SHARED_PATH + '/assignments').add({
                            projectId: task.projectId, masterId: bestMasterId, date: bestDate, period: period, isFixed: false
                        });
                        targetDay.count++;
                        targetDay.regions.add(task.region);
                    }
                }
                setIsProcessing(false);
                setImportText('');
                setParsedTasks([]);
                alert("æ™ºæ…§é›†ä¸­æ’ç¨‹å®Œæˆï¼(å·²ä¿ç•™é–å®šè¡Œç¨‹)");
                setView('schedule');
            };

            const Icons = {
                Map: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>,
                Trash: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
                Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg>,
                X: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>,
                Share: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>,
                Robot: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>,
                Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"/></svg>,
                Lock: () => <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17a2 2 0 100-4 2 2 0 000 4zm6-9h-1V6a5 5 0 00-10 0v2H6a3 3 0 00-3 3v8a3 3 0 003 3h12a3 3 0 003-3v-8a3 3 0 00-3-3zM9 6a3 3 0 016 0v2H9V6z"/></svg>,
                Unlock: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg>
            };

            // --- å¸«å‚…æ¨¡å¼ ---
            if (masterMode) {
                const currentMaster = masters.find(m => m.name === masterMode);
                const tasks = currentMaster ? getTasks(currentMaster.id) : [];
                return (
                    <div className="min-h-screen bg-slate-50 p-4 max-w-lg mx-auto">
                        <header className="glass p-6 rounded-3xl shadow-xl mb-6 text-center border border-white">
                            <div className="w-20 h-20 bg-blue-600 text-white rounded-full flex items-center justify-center text-3xl font-black mx-auto mb-4 shadow-lg">{masterMode[0]}</div>
                            <h1 className="text-2xl font-black text-slate-800 tracking-tight">{masterMode} çš„å·¥ä½œè¡Œç¨‹</h1>
                            <div className="mt-3 inline-flex items-center px-4 py-2 bg-slate-100 rounded-2xl">
                                <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="bg-transparent border-none font-bold text-blue-600 focus:ring-0 text-center" />
                            </div>
                        </header>

                        {tasks.length > 0 ? (
                            <button onClick={() => openMapRoute(currentMaster.id)} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-black py-5 rounded-3xl shadow-blue-200 shadow-2xl flex items-center justify-center gap-3 mb-6 active:scale-95 transition-all">
                                <Icons.Map /> é–‹å§‹å°èˆªè·¯ç·š
                            </button>
                        ) : (
                            <div className="bg-white/50 backdrop-blur-sm p-12 rounded-3xl text-center text-slate-400 border border-slate-200 border-dashed italic">ä»Šå¤©å¯ä»¥ä¼‘æ¯å–”ï¼æš«ç„¡æ’ç¨‹</div>
                        )}

                        <div className="space-y-4">
                            {tasks.map(t => (
                                <div key={t.id} className={`bg-white p-5 rounded-3xl shadow-sm border border-slate-100 card-anim relative overflow-hidden ${t.isFixed ? 'ring-2 ring-red-400' : ''}`}>
                                    <div className={`absolute top-0 left-0 w-2 h-full ${t.isFixed ? 'bg-red-500' : 'bg-blue-500'}`}></div>
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex gap-2">
                                            <span className="text-xs font-black text-blue-700 bg-blue-50 px-3 py-1.5 rounded-full border border-blue-100 uppercase tracking-widest">{t.period || 'å…¨å¤©'}</span>
                                            {t.isFixed && <span className="text-xs font-black text-white bg-red-500 px-2 py-1.5 rounded-full">æ€¥ä»¶</span>}
                                        </div>
                                        <span className={`region-tag px-3 py-1 border text-[10px] ${getRegionStyles(t.project.region)}`}>{t.project.region}</span>
                                    </div>
                                    <h3 className="text-xl font-black text-slate-800 mb-2">{t.project.name}</h3>
                                    <p className="text-slate-500 text-sm flex items-start gap-2 mb-4 leading-relaxed">
                                        <Icons.Map /> {t.project.address || "ç„¡è©³ç´°åœ°å€"}
                                    </p>
                                    <div className="bg-slate-50 p-3 rounded-2xl text-sm text-slate-600 mb-4 font-medium italic border border-slate-100">{t.project.note}</div>
                                    <button onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(t.project.address || t.project.name)}`, '_blank')} className="w-full bg-slate-800 text-white py-3 rounded-2xl flex items-center justify-center gap-2 font-bold text-sm">
                                        <Icons.Map /> å–®é»æŸ¥çœ‹
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            // --- ç®¡ç†å“¡ä»‹é¢ ---
            return (
                <div className="min-h-screen pb-20 max-w-[1440px] mx-auto lg:px-8 px-4">
                    {/* é ‚éƒ¨å°èˆª */}
                    <header className="flex flex-col lg:flex-row justify-between items-center bg-slate-900 text-white p-4 lg:p-6 rounded-b-[2rem] lg:rounded-3xl shadow-2xl mb-8 nav-glow mt-0 lg:mt-4">
                        <div className="flex items-center gap-4 mb-4 lg:mb-0">
                            <div className="bg-gradient-to-br from-blue-400 to-indigo-600 p-3 rounded-2xl text-white shadow-lg rotate-3">
                                <Icons.Robot />
                            </div>
                            <div>
                                <h1 className="text-2xl font-black tracking-tight">å®‰è£æ’ç¨‹åŠ©æ‰‹ <span className="text-blue-400">Pro</span></h1>
                                <div className="flex items-center gap-2">
                                    <span className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                                    <span className="text-[10px] font-bold text-slate-400 tracking-wider uppercase">{statusMsg}</span>
                                </div>
                            </div>
                        </div>
                        <div className="flex bg-slate-800/50 p-1.5 rounded-2xl overflow-x-auto max-w-full glass">
                            {[
                                { id: 'schedule', label: 'æ¯æ—¥æ´¾å·¥' },
                                { id: 'projects', label: 'å»ºæ¡ˆåº«' },
                                { id: 'settings', label: 'å¸«å‚…åå–®' },
                                { id: 'smart', label: 'æ™ºæ…§æ’ç¨‹' }
                            ].map(v => (
                                <button key={v.id} onClick={()=>setView(v.id)} className={`px-6 py-2.5 rounded-xl whitespace-nowrap text-sm font-bold transition-all ${view===v.id ? 'bg-white text-slate-900 shadow-xl scale-105' : 'text-slate-400 hover:text-white'}`}>{v.label}</button>
                            ))}
                        </div>
                    </header>

                    {/* æ’ç¨‹è¦–åœ– */}
                    {view === 'schedule' && (
                        <div className="space-y-6">
                            <div className="bg-white/80 glass p-5 rounded-[2rem] shadow-xl border border-white flex flex-col md:flex-row items-center gap-6">
                                <div className="flex items-center gap-4 bg-slate-100/50 p-2 pr-6 rounded-3xl border border-slate-200/50">
                                    <span className="bg-white p-3 rounded-2xl shadow-sm text-blue-600">ğŸ“…</span>
                                    <div>
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">æ–½å·¥æ—¥æœŸ</p>
                                        <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="bg-transparent border-none font-black text-slate-800 text-lg focus:ring-0 cursor-pointer p-0"/>
                                    </div>
                                </div>
                                <div className="hidden md:block h-10 w-px bg-slate-200"></div>
                                <div className="text-sm font-medium text-slate-500 italic">
                                    "é»æ“Šå¡ç‰‡å³ä¸Šè§’çš„é–é ­ï¼Œå¯å°‡é‡è¦æ’å–®é–å®šï¼Œé¿å…è¢«æ™ºæ…§æ’ç¨‹è¦†è“‹ã€‚"
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                                {/* å»ºæ¡ˆæ±  */}
                                <div className="lg:col-span-4 bg-white/40 glass rounded-[2.5rem] shadow-2xl border border-white h-[800px] flex flex-col overflow-hidden">
                                    <div className="p-6 border-b border-slate-100 bg-white/50 flex justify-between items-center">
                                        <h2 className="text-lg font-black text-slate-800 flex items-center gap-2">
                                            <span className="text-blue-500">ğŸ“‹</span> å¾…æ´¾å·¥å»ºæ¡ˆ
                                        </h2>
                                        <span className="bg-blue-600 text-white text-[10px] font-black px-3 py-1 rounded-full shadow-lg shadow-blue-100">{projects.length}</span>
                                    </div>
                                    <div className="overflow-y-auto p-5 space-y-4 flex-1">
                                        {projects.map(p => (
                                            <div key={p.id} className="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm hover:shadow-xl hover:border-blue-200 transition-all card-anim group">
                                                <div className="flex justify-between items-start mb-3 gap-2">
                                                    <div className="font-black text-slate-800 text-lg leading-tight flex-1">{p.name}</div>
                                                    <span className={`region-tag border shrink-0 ${getRegionStyles(p.region)}`}>{p.region}</span>
                                                </div>
                                                <div className="text-[11px] text-slate-400 mb-3 flex items-center gap-1.5 leading-tight italic">
                                                    <Icons.Map /> {p.address || "ç„¡è©³ç´°åœ°å€"}
                                                </div>
                                                <div className="flex gap-2 border-t border-slate-50 pt-4 mt-2">
                                                    {masters.map(m => {
                                                        const isAssigned = assignments.some(a => a.projectId===p.id && a.masterId===m.id && a.date===selectedDate);
                                                        return (
                                                            <button 
                                                                key={m.id} 
                                                                onClick={()=>assign(p.id, m.id)} 
                                                                disabled={isAssigned} 
                                                                className={`flex-1 h-9 rounded-xl text-[11px] font-black transition-all border shadow-sm flex items-center justify-center ${isAssigned ? 'bg-green-500 border-green-600 text-white cursor-default scale-95 shadow-inner' : 'bg-white border-slate-200 text-slate-400 hover:bg-slate-900 hover:text-white hover:border-slate-900'}`}
                                                                title={`æ´¾çµ¦ ${m.name}`}
                                                            >
                                                                {isAssigned ? <Icons.Check/> : m.name[0]}
                                                            </button>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* å¸«å‚…æ¬„ä½ */}
                                <div className="lg:col-span-8 overflow-x-auto pb-6">
                                    <div className="flex gap-6 min-w-[1000px] h-full">
                                        {masters.map(m => {
                                            const tasks = getTasks(m.id);
                                            return (
                                                <div key={m.id} className="flex-1 min-w-[280px] bg-white/40 glass rounded-[2.5rem] shadow-2xl border border-white h-[800px] flex flex-col overflow-hidden">
                                                    <div className="p-6 border-b-4 border-slate-100/50" style={{ borderBottomColor: m.color.includes('blue') ? '#3b82f6' : m.color.includes('amber') ? '#f59e0b' : m.color.includes('emerald') ? '#10b981' : m.color.includes('violet') ? '#8b5cf6' : '#78716c' }}>
                                                        <div className="flex justify-between items-center mb-4">
                                                            <span className="text-2xl font-black text-slate-800 tracking-tighter">{m.name}</span>
                                                            <span className="text-[10px] font-black bg-slate-900 text-white px-3 py-1 rounded-full uppercase tracking-widest">{m.skill}</span>
                                                        </div>
                                                        <button onClick={() => openMapRoute(m.id)} className="w-full bg-white hover:bg-slate-50 text-slate-800 text-[11px] font-black py-3 rounded-2xl border border-slate-200 flex items-center justify-center gap-2 shadow-sm transition-all active:scale-95">
                                                            <Icons.Map /> å…¨æ—¥è·¯ç·šå°èˆª
                                                        </button>
                                                    </div>
                                                    <div className="p-4 space-y-4 overflow-y-auto flex-1 bg-slate-50/30">
                                                        {tasks.map(t => (
                                                            <div key={t.id} className={`bg-white p-5 rounded-3xl border shadow-sm relative group card-anim border-l-4 ${t.isFixed ? 'border-red-500 ring-2 ring-red-100' : 'border-slate-100'}`} style={{borderLeftColor: t.isFixed ? '#ef4444' : m.color.split(' ')[0].replace('bg-', '') }}>
                                                                <div className="flex justify-between text-[10px] text-slate-400 mb-3 border-b border-slate-50 pb-2">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="font-black text-blue-600 uppercase tracking-widest">{t.period || 'å…¨å¤©'}</span>
                                                                        {/* é–å®šæŒ‰éˆ• */}
                                                                        <button onClick={() => toggleLock(t.id, t.isFixed)} className={`transition-colors ${t.isFixed ? 'text-red-500' : 'text-slate-300 hover:text-slate-500'}`} title={t.isFixed ? "æ€¥ä»¶é–å®šä¸­ (ä¸æœƒè¢«é‡æ’)" : "é»æ“Šé–å®š"}>
                                                                            {t.isFixed ? <Icons.Lock/> : <Icons.Unlock/>}
                                                                        </button>
                                                                    </div>
                                                                    <button onClick={()=>removeAssign(t.id)} className="text-slate-300 hover:text-rose-500 transition-colors"><Icons.X/></button>
                                                                </div>
                                                                <div className="font-black text-slate-800 text-base mb-1">{t.project.name}</div>
                                                                <div className="text-[11px] text-slate-500 mt-1 flex items-start gap-1">
                                                                    <span className="mt-0.5">ğŸ“</span>
                                                                    <span className="flex-1">{t.project.address || t.project.region}</span>
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {tasks.length === 0 && (
                                                            <div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-50 space-y-2">
                                                                <span className="text-3xl">â˜•</span>
                                                                <span className="text-xs font-bold italic">ç›®å‰ç„¡è¡Œç¨‹</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* æ™ºæ…§æ’ç¨‹è¦–åœ– */}
                    {view === 'smart' && (
                        <div className="bg-slate-900 rounded-[3rem] shadow-2xl p-8 lg:p-12 text-white card-anim relative overflow-hidden">
                            <div className="absolute -top-24 -right-24 w-96 h-96 bg-blue-600/20 rounded-full blur-3xl"></div>
                            <div className="relative z-10">
                                <div className="flex items-center gap-4 mb-8">
                                    <div className="bg-blue-500 p-4 rounded-3xl text-white shadow-2xl shadow-blue-500/50 rotate-6">
                                        <Icons.Robot />
                                    </div>
                                    <div>
                                        <h2 className="text-4xl font-black tracking-tighter">æ™ºæ…§æ’ç¨‹ä¸­å¿ƒ</h2>
                                        <p className="text-blue-300 text-sm font-medium">åŸºæ–¼å€åŸŸèšé›†æ¼”ç®—æ³•è‡ªå‹•åˆ†é…æœ€å„ªè¡Œç¨‹</p>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
                                    <div className="space-y-6">
                                        <label className="font-black text-lg block text-slate-300">1. è¼¸å…¥å»ºæ¡ˆè³‡æ–™æ¸…å–®</label>
                                        <div className="bg-slate-800/50 p-4 rounded-3xl border border-slate-700/50 text-xs text-slate-400 italic mb-4">
                                            æ”¯æ´æ ¼å¼ï¼š<span className="text-blue-400 font-bold">å»ºæ¡ˆåç¨±, å€åŸŸ, è©³ç´°åœ°å€, å¸«å‚…åå­— (å¯é¸)</span>
                                        </div>
                                        <textarea 
                                            className="w-full h-80 p-6 border border-slate-700 rounded-3xl bg-slate-800/50 text-white font-mono text-sm focus:ring-4 focus:ring-blue-500/20 outline-none transition-all"
                                            placeholder="åœ¨æ­¤è²¼ä¸Šå¤šç­†è³‡æ–™..."
                                            value={importText}
                                            onChange={e => setImportText(e.target.value)}
                                        ></textarea>
                                        <button onClick={parseTasks} className="w-full bg-blue-600 text-white font-black py-5 rounded-[2rem] hover:bg-blue-500 transition-all shadow-xl shadow-blue-900/50 flex items-center justify-center gap-3 active:scale-95">åˆ†æä¸¦é è¦½è³‡æ–™</button>
                                    </div>
                                    <div className="flex flex-col h-full">
                                        <label className="font-black text-lg block text-slate-300 mb-6">2. ç³»çµ±é è¦½èˆ‡åŸ·è¡Œ</label>
                                        <div className="flex-1 border border-slate-700 rounded-[2.5rem] bg-slate-800/30 overflow-y-auto p-6 mb-6">
                                            {parsedTasks.length === 0 ? (
                                                <div className="h-full flex flex-col items-center justify-center text-slate-600 space-y-4 italic">
                                                    <span className="text-5xl opacity-20">ğŸ“Š</span>
                                                    <span>ç­‰å¾…è³‡æ–™åˆ†æ...</span>
                                                </div>
                                            ) : (
                                                <div className="space-y-3">
                                                    {parsedTasks.map((t, idx) => (
                                                        <div key={idx} className="bg-slate-800 p-4 rounded-2xl flex justify-between items-center border border-slate-700 hover:border-blue-500/50 transition-all group shadow-sm">
                                                            <div className="flex-1">
                                                                <div className="font-black text-sm text-slate-200 group-hover:text-white">{t.name}</div>
                                                                <div className="text-[10px] text-slate-500 mt-1 truncate max-w-[200px]">{t.address}</div>
                                                            </div>
                                                            <div className="flex flex-col items-end gap-1.5">
                                                                <span className={`px-2 py-0.5 rounded-lg text-[10px] font-black border ${getRegionStyles(t.region).replace('bg-', 'text-')}`}>{t.region}</span>
                                                                {t.targetMaster ? (
                                                                    <span className="bg-blue-600/20 text-blue-400 px-2 py-0.5 rounded-lg text-[9px] font-black border border-blue-500/30">æŒ‡å®šï¼š{t.targetMaster.name}</span>
                                                                ) : (
                                                                    <span className="text-[9px] font-bold text-slate-600 uppercase tracking-tighter">è‡ªå‹•åˆ†é…</span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        <div className="bg-slate-800 p-8 rounded-[2.5rem] border border-slate-700 shadow-2xl">
                                            <div className="mb-6">
                                                <span className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-2 block">æ’ç¨‹èµ·å§‹æ—¥æœŸ</span>
                                                <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-4 rounded-2xl text-white font-bold" />
                                            </div>
                                            <label className="flex items-center gap-3 cursor-pointer bg-slate-900 p-4 rounded-2xl border border-slate-700 mb-6 hover:bg-slate-800 transition-all">
                                                <input type="checkbox" checked={replanExisting} onChange={e=>setReplanExisting(e.target.checked)} className="w-5 h-5 text-blue-600 rounded-lg bg-slate-800 border-slate-600" />
                                                <span className="text-sm font-bold text-slate-300">é‡æ’æœªä¾†è¡Œç¨‹ <span className="text-red-400">(é–å®šè¡Œç¨‹å°‡è¢«ä¿ç•™)</span></span>
                                            </label>
                                            <button 
                                                onClick={executeSchedule}
                                                disabled={parsedTasks.length === 0 || isProcessing}
                                                className={`w-full py-5 rounded-[2rem] font-black text-white shadow-2xl transition-all flex items-center justify-center gap-3 ${isProcessing ? 'bg-slate-600' : 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:scale-105 active:scale-95'}`}
                                            >
                                                {isProcessing ? "æ¼”ç®—æ³•è¨ˆç®—ä¸­..." : "ç«‹åˆ»å•Ÿå‹•è‡ªå‹•é›†ä¸­æ’ç¨‹"}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* å»ºæ¡ˆåœ¨åº«è¦–åœ– */}
                    {view === 'projects' && (
                        <div className="bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 p-8 card-anim overflow-hidden">
                            <div className="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
                                <div>
                                    <h2 className="text-3xl font-black text-slate-800 tracking-tight flex items-center gap-3">
                                        <span className="text-blue-600">ğŸ“‚</span> å»ºæ¡ˆåœ¨åº«ç®¡ç†
                                    </h2>
                                    <p className="text-slate-400 font-medium text-sm mt-1 uppercase tracking-widest">Active Project Database</p>
                                </div>
                                <button onClick={()=>setIsFormOpen(true)} className="bg-slate-900 text-white px-8 py-4 rounded-[2rem] font-black flex items-center gap-3 shadow-xl hover:bg-blue-600 transition-all active:scale-95">
                                    <Icons.Plus /> æ‰‹å‹•æ–°å¢å»ºæ¡ˆ
                                </button>
                            </div>
                            
                            {isFormOpen && (
                                <div className="mb-10 p-8 bg-slate-50 rounded-[2.5rem] border border-slate-200 grid grid-cols-1 md:grid-cols-5 gap-4 shadow-inner card-anim">
                                    <input placeholder="å»ºæ¡ˆåç¨±" className="p-4 border rounded-2xl text-sm font-bold shadow-sm" value={newProject.name} onChange={e=>setNewProject({...newProject, name:e.target.value})} />
                                    <input placeholder="å€åŸŸ" className="p-4 border rounded-2xl text-sm font-bold shadow-sm" value={newProject.region} onChange={e=>setNewProject({...newProject, region:e.target.value})} />
                                    <input placeholder="åœ°å€" className="p-4 border rounded-2xl text-sm font-bold shadow-sm" value={newProject.address} onChange={e=>setNewProject({...newProject, address:e.target.value})} />
                                    <input placeholder="å‚™è¨»å…§å®¹" className="p-4 border rounded-2xl text-sm font-bold shadow-sm" value={newProject.note} onChange={e=>setNewProject({...newProject, note:e.target.value})} />
                                    <div className="flex gap-3">
                                        <button onClick={addProject} className="flex-1 bg-blue-600 text-white rounded-2xl font-black shadow-lg">å„²å­˜æ¡ˆå­</button>
                                        <button onClick={()=>setIsFormOpen(false)} className="px-6 bg-white border border-slate-200 rounded-2xl text-slate-500 font-bold hover:bg-slate-100">å–æ¶ˆ</button>
                                    </div>
                                </div>
                            )}

                            <div className="overflow-x-auto rounded-[2rem] border border-slate-100">
                                <table className="w-full text-left">
                                    <thead>
                                        <tr className="bg-slate-900 text-slate-400 text-[10px] font-black uppercase tracking-[0.2em]">
                                            <th className="p-6">å€åŸŸæ¨™ç±¤</th>
                                            <th className="p-6">å»ºæ¡ˆåç¨±</th>
                                            <th className="p-6">è©³ç´°åœ°å€</th>
                                            <th className="p-6">å‚™è¨»äº‹é …</th>
                                            <th className="p-6 text-center">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {projects.map(p => (
                                            <tr key={p.id} className="hover:bg-slate-50/80 transition-all group">
                                                <td className="p-6 w-32">
                                                    <EditableInput className={`region-tag border text-center font-black w-full bg-transparent ${getRegionStyles(p.region)}`} value={p.region} onSave={v=>updateProject(p.id, 'region', v)} />
                                                </td>
                                                <td className="p-6 font-black text-slate-800 text-base">
                                                    <EditableInput className="w-full border-none bg-transparent font-black focus:bg-white focus:shadow-md focus:p-2 rounded-xl" value={p.name} onSave={v=>updateProject(p.id, 'name', v)} />
                                                </td>
                                                <td className="p-6 text-sm text-slate-500 leading-relaxed">
                                                    <EditableInput className="w-full border-none bg-transparent focus:bg-white focus:shadow-md focus:p-2 rounded-xl" value={p.address} onSave={v=>updateProject(p.id, 'address', v)} />
                                                </td>
                                                <td className="p-6 text-sm text-slate-400 italic">
                                                    <EditableInput className="w-full border-none bg-transparent focus:bg-white focus:shadow-md focus:p-2 rounded-xl" value={p.note} onSave={v=>updateProject(p.id, 'note', v)} />
                                                </td>
                                                <td className="p-6 text-center">
                                                    <button onClick={()=>deleteProject(p.id)} className="text-slate-300 hover:text-rose-500 transition-all p-3 hover:bg-rose-50 rounded-2xl group-hover:scale-110">
                                                        <Icons.Trash/>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* å¸«å‚…è¨­å®šè¦–åœ– */}
                    {view === 'settings' && (
                        <div className="max-w-4xl mx-auto space-y-8 card-anim">
                            <div className="text-center mb-12">
                                <h2 className="text-4xl font-black text-slate-800 tracking-tighter">å¸«å‚…ç®¡ç†èˆ‡åˆ†äº«ä¸­å¿ƒ</h2>
                                <p className="text-slate-400 mt-2 font-medium italic">é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¤‡è£½å°ˆå±¬è¡Œç¨‹ç¶²å€å‚³é€çµ¦å¸«å‚…</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                {masters.map(m => (
                                    <div key={m.id} className="p-8 bg-white rounded-[2.5rem] shadow-xl border border-slate-100 flex flex-col items-center text-center relative overflow-hidden group">
                                        <div className="absolute top-0 left-0 w-full h-2 shadow-inner opacity-80" style={{ backgroundColor: m.color.split(' ')[0].replace('bg-', '') }}></div>
                                        <div className={`w-24 h-24 rounded-full flex items-center justify-center font-black text-3xl mb-4 shadow-2xl text-white shadow-slate-200 border-4 border-white ${m.color.split(' ')[0]}`}>{m.name[0]}</div>
                                        <div className="mb-8 w-full">
                                            <EditableInput className="font-black text-2xl text-slate-800 bg-transparent w-full border-none p-0 focus:ring-0 text-center mb-1" value={m.name} onSave={v=>updateMaster(m.id, 'name', v)} />
                                            <EditableInput className="text-sm font-bold text-slate-400 bg-transparent w-full border-none p-0 focus:ring-0 text-center uppercase tracking-widest" value={m.skill} onSave={v=>updateMaster(m.id, 'skill', v)} />
                                        </div>
                                        <button onClick={() => copyShareLink(m.name)} className="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black flex items-center justify-center gap-3 hover:bg-blue-600 transition-all shadow-xl shadow-slate-100 active:scale-95">
                                            <Icons.Share /> è¤‡è£½å¸«å‚…å°ˆå±¬ç¶²å€
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
