<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰è£æ’ç¨‹</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- å¼•å…¥æ¼‚äº®çš„å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif; 
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
        }
        
        .loading { display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.2rem; color: #64748b; font-weight: bold; }
        
        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* è¼¸å…¥æ¡†ç¾åŒ– */
        input:focus, textarea:focus { 
            outline: none; 
            border-color: #6366f1; 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); 
        }

        /* ç»ç’ƒæ“¬æ…‹å¡ç‰‡ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* å‹•ç•« */
        .card-anim { 
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            transition: all 0.2s ease; 
        }
        .card-anim:hover { transform: translateY(-2px); }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .region-tag {
            font-size: 0.7rem;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 99px;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body class="min-h-screen pb-20">
    <div id="root">
        <div class="loading">
            <div class="flex flex-col items-center gap-4">
                <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                <span>ç³»çµ±é€£ç·šä¸­...</span>
            </div>
        </div>
    </div>

    <script type="text/babel">
        // --- Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBN_fK1oEhocmRCdWy0pfnaLVbhmZQdxlM",
            authDomain: "gogo-ed64b.firebaseapp.com",
            projectId: "gogo-ed64b",
            storageBucket: "gogo-ed64b.firebasestorage.app",
            messagingSenderId: "121319123217",
            appId: "1:121319123217:web:804f0adafd61cf82bc04b0"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const SHARED_PATH = 'company_data/shared_schedule';

        // --- é¡è‰²ç”Ÿæˆå™¨ (æ›´æŸ”å’Œçš„è‰²ç³») ---
        const getRegionStyles = (region) => {
            if (!region || region === 'æœªåˆ†é¡') return "bg-slate-100 text-slate-500 border border-slate-200";
            const hash = region.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const palettes = [
                "bg-blue-50 text-blue-600 border border-blue-100",
                "bg-rose-50 text-rose-600 border border-rose-100",
                "bg-amber-50 text-amber-600 border border-amber-100",
                "bg-emerald-50 text-emerald-600 border border-emerald-100",
                "bg-violet-50 text-violet-600 border border-violet-100",
                "bg-cyan-50 text-cyan-600 border border-cyan-100",
                "bg-orange-50 text-orange-600 border border-orange-100",
                "bg-fuchsia-50 text-fuchsia-600 border border-fuchsia-100"
            ];
            return palettes[hash % palettes.length];
        };

        const EditableInput = ({ value, onSave, className, placeholder, type="text" }) => {
            const [localValue, setLocalValue] = React.useState(value || '');
            React.useEffect(() => { setLocalValue(value || ''); }, [value]);
            const handleBlur = () => { if (localValue !== value) onSave(localValue); };
            const handleKeyDown = (e) => { if (e.key === 'Enter') handleBlur(); };

            return (
                <input 
                    type={type}
                    className={`bg-transparent transition-colors duration-200 ${className}`} 
                    value={localValue} 
                    onChange={e => setLocalValue(e.target.value)} 
                    onBlur={handleBlur}
                    onKeyDown={handleKeyDown}
                    placeholder={placeholder} 
                />
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [projects, setProjects] = React.useState([]);
            const [assignments, setAssignments] = React.useState([]);
            const [masters, setMasters] = React.useState([]);
            const [statusMsg, setStatusMsg] = React.useState('é€£ç·šä¸­...');
            const [selectedDate, setSelectedDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [view, setView] = React.useState('schedule');
            const [masterMode, setMasterMode] = React.useState(null);

            const [importText, setImportText] = React.useState('');
            const [parsedTasks, setParsedTasks] = React.useState([]);
            const [isProcessing, setIsProcessing] = React.useState(false);
            const [replanExisting, setReplanExisting] = React.useState(false);
            
            const [newProject, setNewProject] = React.useState({ name: '', region: '', address: '', note: '' });
            const [isFormOpen, setIsFormOpen] = React.useState(false);

            const defaultMasters = [
                { name: "é™³å¸«å‚…", skill: "æ°´é›»", color: "bg-blue-500 text-white" },
                { name: "æ—å¸«å‚…", skill: "æœ¨å·¥", color: "bg-amber-500 text-white" },
                { name: "å¼µå¸«å‚…", skill: "æ³¥ä½œ", color: "bg-slate-600 text-white" },
                { name: "ç‹å¸«å‚…", skill: "æ²¹æ¼†", color: "bg-emerald-500 text-white" },
                { name: "æå¸«å‚…", skill: "é›œé …", color: "bg-violet-500 text-white" }
            ];

            React.useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const mName = urlParams.get('m');
                if (mName) {
                    setMasterMode(mName);
                    setView('masterView');
                }

                auth.signInAnonymously().catch(e => setStatusMsg("é€£ç·šå¤±æ•—"));
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u) {
                        setStatusMsg(mName ? `ğŸ‘· ${mName}` : "ğŸŸ¢ ç·šä¸Š");
                        db.collection(SHARED_PATH + '/projects').onSnapshot(s => setProjects(s.docs.map(d => ({id: d.id, ...d.data()}))));
                        db.collection(SHARED_PATH + '/assignments').onSnapshot(s => setAssignments(s.docs.map(d => ({id: d.id, ...d.data()}))));
                        db.collection(SHARED_PATH + '/masters').onSnapshot(s => {
                            const list = s.docs.map(d => ({id: d.id, ...d.data()}));
                            if (list.length === 0) defaultMasters.forEach(m => db.collection(SHARED_PATH + '/masters').add(m));
                            else setMasters(list.sort((a,b) => a.name.localeCompare(b.name)));
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            const updateProject = (id, key, val) => db.doc(`${SHARED_PATH}/projects/${id}`).update({ [key]: val });
            const deleteProject = (id) => {
                if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
                db.doc(`${SHARED_PATH}/projects/${id}`).delete();
                assignments.filter(a => a.projectId === id).forEach(a => db.doc(`${SHARED_PATH}/assignments/${a.id}`).delete());
            };
            const addProject = () => {
                if (!newProject.name) return;
                db.collection(`${SHARED_PATH}/projects`).add({ ...newProject, createdAt: Date.now() });
                setNewProject({ name: '', region: '', address: '', note: '' });
                setIsFormOpen(false);
            };
            const assign = (pid, mid) => {
                const exists = assignments.find(a => a.date === selectedDate && a.masterId === mid && a.projectId === pid);
                if (exists) return;
                db.collection(`${SHARED_PATH}/assignments`).add({ projectId: pid, masterId: mid, date: selectedDate, period: 'å…¨å¤©', isFixed: false });
            };
            const removeAssign = (aid) => db.doc(`${SHARED_PATH}/assignments/${aid}`).delete();
            const updateMaster = (id, key, val) => db.doc(`${SHARED_PATH}/masters/${id}`).update({ [key]: val });
            const toggleLock = (aid, currentStatus) => {
                db.doc(`${SHARED_PATH}/assignments/${aid}`).update({ isFixed: !currentStatus });
            };

            const getTasks = (mid, date = selectedDate) => assignments
                .filter(a => a.date === date && a.masterId === mid)
                .map(a => ({ ...a, project: projects.find(p => p.id === a.projectId) }))
                .filter(t => t.project)
                .sort((a, b) => (a.project.region || '').localeCompare(b.project.region || ''));

            const openMapRoute = (mId) => {
                const tasks = getTasks(mId);
                if (tasks.length === 0) return alert("ä»Šå¤©æ²’æœ‰è¡Œç¨‹");
                const dests = tasks.map(t => encodeURIComponent(t.project.address || `${t.project.region} ${t.project.name}`));
                window.open(`https://www.google.com/maps/dir/${dests.join('/')}`, '_blank');
            };

            const copyShareLink = (mName) => {
                const baseUrl = window.location.href.split('?')[0];
                const shareUrl = `${baseUrl}?m=${encodeURIComponent(mName)}`;
                const el = document.createElement('textarea');
                el.value = shareUrl;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                alert(`å·²è¤‡è£½ ${mName} çš„å°ˆå±¬é€£çµã€‚`);
            };

            const parseTasks = () => {
                const lines = importText.split('\n').filter(l => l.trim());
                const tasks = lines.map(line => {
                    const parts = line.split(/[,ï¼Œ\t]+/).map(p => p.trim());
                    let name = parts[0] || 'æœªå‘½å';
                    let region = 'æœªåˆ†é¡';
                    let address = '';
                    let note = line;
                    let targetMaster = null;

                    if (parts.length >= 2) {
                        if (parts[1].length < 6) { region = parts[1]; if (parts[2]) address = parts[2]; }
                        else { address = parts[1]; }
                    }
                    const distMatch = line.match(/(\w+[å¸‚ç¸£])?(\w+[å€é„‰é®å¸‚])/);
                    if (distMatch) region = distMatch[2];
                    
                    masters.forEach(m => { if(line.includes(m.name)) targetMaster = m; });
                    return { name, region, address, note, targetMaster };
                });
                setParsedTasks(tasks);
            };

            const executeSchedule = async () => {
                if (replanExisting && !confirm("ç¢ºå®šè¦åŸ·è¡Œå…¨åŸŸé‡æ’ï¼Ÿ\nâš ï¸ ç³»çµ±æœƒä¿ç•™ã€Œå·²é–å®šã€çš„è¡Œç¨‹ï¼Œä½†æœƒæ¸…é™¤ä¸¦é‡æ–°å®‰æ’å…¶ä»–æœªä¾†è¡Œç¨‹ã€‚")) return;
                setIsProcessing(true);

                const tasksToAssign = [];
                for (const t of parsedTasks) {
                    const doc = await db.collection(SHARED_PATH + '/projects').add({
                        ...t, createdAt: Date.now()
                    });
                    tasksToAssign.push({
                        projectId: doc.id,
                        region: t.region,
                        masterId: t.targetMaster ? t.targetMaster.id : null
                    });
                }

                let pool = [...tasksToAssign];
                if (replanExisting) {
                    const futureToReplan = assignments.filter(a => a.date >= selectedDate && !a.isFixed);
                    for (const a of futureToReplan) {
                        await db.doc(`${SHARED_PATH}/assignments/${a.id}`).delete();
                        const p = projects.find(proj => proj.id === a.projectId);
                        if (p) pool.push({ projectId: a.projectId, region: p.region, masterId: a.masterId });
                    }
                }

                const masterDayStatus = {}; 
                const existing = replanExisting 
                    ? assignments.filter(a => a.date < selectedDate || (a.date >= selectedDate && a.isFixed)) 
                    : assignments;

                existing.forEach(a => {
                    if (!masterDayStatus[a.masterId]) masterDayStatus[a.masterId] = {};
                    if (!masterDayStatus[a.masterId][a.date]) masterDayStatus[a.masterId][a.date] = { count: 0, regions: new Set() };
                    masterDayStatus[a.masterId][a.date].count++;
                    const proj = projects.find(p => p.id === a.projectId);
                    if (proj) masterDayStatus[a.masterId][a.date].regions.add(proj.region);
                });

                pool.sort((a,b) => a.region.localeCompare(b.region));

                for (const task of pool) {
                    let bestDate = null;
                    let bestMasterId = task.masterId;
                    let maxScore = -Infinity;
                    const potentialMasters = bestMasterId ? [masters.find(m => m.id === bestMasterId)] : masters;
                    
                    for (const m of potentialMasters) {
                        if (!m) continue;
                        for (let i = 0; i < 30; i++) {
                            const d = new Date(selectedDate);
                            d.setDate(d.getDate() + i);
                            const dStr = d.toISOString().split('T')[0];
                            if (!masterDayStatus[m.id]) masterDayStatus[m.id] = {};
                            const day = masterDayStatus[m.id][dStr] || { count: 0, regions: new Set() };
                            if (day.count >= 3) continue;
                            let score = 1000;
                            if (day.regions.has(task.region)) score += 5000; 
                            else if (day.count === 0) score += 500;
                            score -= i * 50;
                            if (score > maxScore) { maxScore = score; bestDate = dStr; bestMasterId = m.id; }
                        }
                    }

                    if (bestDate && bestMasterId) {
                        if (!masterDayStatus[bestMasterId][bestDate]) masterDayStatus[bestMasterId][bestDate] = { count: 0, regions: new Set() };
                        const targetDay = masterDayStatus[bestMasterId][bestDate];
                        const periods = ['ä¸Šåˆ', 'ä¸‹åˆ', 'å‚æ™š'];
                        const period = periods[targetDay.count] || 'å…¨å¤©';
                        await db.collection(SHARED_PATH + '/assignments').add({
                            projectId: task.projectId, masterId: bestMasterId, date: bestDate, period: period, isFixed: false
                        });
                        targetDay.count++;
                        targetDay.regions.add(task.region);
                    }
                }
                setIsProcessing(false);
                setImportText('');
                setParsedTasks([]);
                alert("å®Œæˆï¼æ™ºæ…§é›†ä¸­æ’ç¨‹å®Œç•¢ã€‚");
                setView('schedule');
            };

            const Icons = {
                Map: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>,
                Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
                Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg>,
                X: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>,
                Share: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>,
                Robot: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>,
                Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"/></svg>,
                Lock: () => <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17a2 2 0 100-4 2 2 0 000 4zm6-9h-1V6a5 5 0 00-10 0v2H6a3 3 0 00-3 3v8a3 3 0 003 3h12a3 3 0 003-3v-8a3 3 0 00-3-3zM9 6a3 3 0 016 0v2H9V6z"/></svg>,
                Unlock: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg>
            };

            // --- å¸«å‚…æ¨¡å¼ ---
            if (masterMode) {
                const currentMaster = masters.find(m => m.name === masterMode);
                const tasks = currentMaster ? getTasks(currentMaster.id) : [];
                return (
                    <div className="min-h-screen p-4 max-w-lg mx-auto bg-slate-50">
                        <header className="bg-white p-6 rounded-3xl shadow-xl shadow-slate-200/50 mb-6 text-center border border-white">
                            <div className={`w-16 h-16 mx-auto rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-lg mb-3 ${currentMaster ? currentMaster.color.split(' ')[0] : 'bg-slate-400'}`}>
                                {masterMode[0]}
                            </div>
                            <h1 className="text-xl font-bold text-slate-800 tracking-tight">{masterMode} çš„å·¥ä½œè¡Œç¨‹</h1>
                            <div className="mt-3 inline-block px-4 py-1.5 bg-slate-100 rounded-full">
                                <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="bg-transparent border-none font-bold text-slate-600 focus:ring-0 text-center text-sm" />
                            </div>
                        </header>

                        {tasks.length > 0 ? (
                            <button onClick={() => openMapRoute(currentMaster.id)} className="w-full bg-gradient-to-r from-indigo-500 to-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 mb-6 active:scale-95 transition-all">
                                <Icons.Map /> é–‹å§‹ä»Šæ—¥è·¯ç·šå°èˆª
                            </button>
                        ) : (
                            <div className="bg-white/60 p-10 rounded-3xl text-center text-slate-400 border border-dashed border-slate-300">ä»Šå¤©ç„¡æ’ç¨‹ï¼Œå¯ä»¥ä¼‘æ¯å–”ï¼â˜•</div>
                        )}

                        <div className="space-y-4">
                            {tasks.map(t => (
                                <div key={t.id} className={`bg-white p-5 rounded-3xl shadow-sm border border-slate-100 card-anim relative overflow-hidden ${t.isFixed ? 'ring-1 ring-rose-400' : ''}`}>
                                    <div className={`absolute top-0 left-0 w-1.5 h-full ${t.isFixed ? 'bg-rose-500' : 'bg-indigo-500'}`}></div>
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="flex gap-2">
                                            <span className="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md">{t.period || 'å…¨å¤©'}</span>
                                            {t.isFixed && <span className="text-xs font-bold text-white bg-rose-500 px-2 py-1 rounded-md">æ€¥ä»¶</span>}
                                        </div>
                                        <span className={`region-tag ${getRegionStyles(t.project.region)}`}>{t.project.region}</span>
                                    </div>
                                    <h3 className="text-lg font-bold text-slate-800 mb-1">{t.project.name}</h3>
                                    <p className="text-slate-500 text-sm flex items-start gap-1 mb-3">
                                        <span className="mt-0.5"><Icons.Map /></span> {t.project.address || "ç„¡è©³ç´°åœ°å€"}
                                    </p>
                                    {t.project.note && <div className="bg-slate-50 p-3 rounded-2xl text-sm text-slate-600 mb-4">{t.project.note}</div>}
                                    <button onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(t.project.address || t.project.name)}`, '_blank')} className="w-full bg-slate-800 text-white py-2.5 rounded-xl flex items-center justify-center gap-2 font-bold text-sm hover:bg-slate-700 transition-colors">
                                        <Icons.Map /> å–®é»æŸ¥çœ‹
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            // --- ç®¡ç†å“¡ä»‹é¢ ---
            return (
                <div className="max-w-[1400px] mx-auto lg:px-8 px-4 py-4">
                    {/* é ‚éƒ¨å°èˆª */}
                    <header className="flex flex-col lg:flex-row justify-between items-center bg-slate-900 text-white p-4 lg:p-5 rounded-[2rem] shadow-2xl mb-8 mt-2 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-500 rounded-full filter blur-[80px] opacity-20 -mr-16 -mt-16 pointer-events-none"></div>
                        
                        <div className="flex items-center gap-4 mb-4 lg:mb-0 z-10">
                            <div className="bg-white/10 backdrop-blur-md p-3 rounded-2xl text-white shadow-inner border border-white/20">
                                <Icons.Robot />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold tracking-wide">å·¥ç­èª¿åº¦åŠ©æ‰‹ <span className="text-indigo-400">Pro</span></h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                                    <span className="text-xs font-medium text-slate-400 uppercase tracking-wider">{statusMsg}</span>
                                </div>
                            </div>
                        </div>
                        <div className="flex bg-slate-800/50 p-1.5 rounded-2xl overflow-x-auto max-w-full glass-panel border-0 z-10">
                            {[
                                { id: 'schedule', label: 'æ¯æ—¥æ´¾å·¥' },
                                { id: 'projects', label: 'å»ºæ¡ˆåº«' },
                                { id: 'settings', label: 'å¸«å‚…åå–®' },
                                { id: 'smart', label: 'æ™ºæ…§æ’ç¨‹' }
                            ].map(v => (
                                <button key={v.id} onClick={()=>setView(v.id)} className={`px-5 py-2 rounded-xl whitespace-nowrap text-sm font-bold transition-all ${view===v.id ? 'bg-white text-slate-900 shadow-lg scale-105' : 'text-slate-400 hover:text-white'}`}>{v.label}</button>
                            ))}
                        </div>
                    </header>

                    {/* æ’ç¨‹è¦–åœ– */}
                    {view === 'schedule' && (
                        <div className="space-y-6">
                            <div className="bg-white/80 glass-panel p-4 rounded-3xl shadow-sm flex flex-col md:flex-row items-center justify-between gap-6">
                                <div className="flex items-center gap-3">
                                    <div className="bg-indigo-100 p-2 rounded-xl text-indigo-600">ğŸ“…</div>
                                    <div className="flex flex-col">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase">æ–½å·¥æ—¥æœŸ</label>
                                        <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="bg-transparent border-none font-bold text-slate-700 text-lg p-0 focus:ring-0 cursor-pointer"/>
                                    </div>
                                </div>
                                <div className="text-xs font-medium text-slate-400 bg-slate-100 px-4 py-2 rounded-full">
                                    æç¤ºï¼šé»æ“Šå¡ç‰‡å³ä¸Šè§’çš„é–é ­ <span className="text-rose-500"><Icons.Lock/></span> å¯é–å®šæ€¥ä»¶
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                                {/* å»ºæ¡ˆæ±  */}
                                <div className="lg:col-span-3 bg-white/60 glass-panel rounded-[2rem] shadow-xl border-0 h-[800px] flex flex-col overflow-hidden">
                                    <div className="p-5 border-b border-slate-200/50 bg-white/50 flex justify-between items-center backdrop-blur-sm">
                                        <h2 className="font-bold text-slate-700 flex items-center gap-2">
                                            å¾…æ´¾å·¥ <span className="bg-slate-200 text-slate-600 text-xs px-2 py-0.5 rounded-full">{projects.length}</span>
                                        </h2>
                                        <button onClick={()=>setView('projects')} className="w-8 h-8 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100 transition-colors"><Icons.Plus/></button>
                                    </div>
                                    <div className="overflow-y-auto p-4 space-y-3 flex-1">
                                        {projects.map(p => (
                                            <div key={p.id} className="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 hover:shadow-md hover:border-indigo-200 transition-all card-anim group">
                                                <div className="flex justify-between items-start mb-2 gap-2">
                                                    <div className="font-bold text-slate-800 text-sm leading-tight flex-1">{p.name}</div>
                                                    <span className={`region-tag ${getRegionStyles(p.region)}`}>{p.region}</span>
                                                </div>
                                                <div className="text-xs text-slate-400 mb-3 flex items-start gap-1 leading-tight">
                                                    <span className="mt-0.5"><Icons.Map /></span> <span className="line-clamp-2">{p.address || "ç„¡è©³ç´°åœ°å€"}</span>
                                                </div>
                                                <div className="grid grid-cols-5 gap-1 border-t border-slate-50 pt-3">
                                                    {masters.map(m => {
                                                        const isAssigned = assignments.some(a => a.projectId===p.id && a.masterId===m.id && a.date===selectedDate);
                                                        return (
                                                            <button 
                                                                key={m.id} 
                                                                onClick={()=>assign(p.id, m.id)} 
                                                                disabled={isAssigned} 
                                                                className={`h-8 rounded-lg text-[10px] font-bold transition-all flex items-center justify-center ${isAssigned ? 'bg-emerald-500 text-white shadow-inner' : 'bg-slate-50 text-slate-400 hover:bg-indigo-600 hover:text-white'}`}
                                                                title={`æ´¾çµ¦ ${m.name}`}
                                                            >
                                                                {isAssigned ? <Icons.Check/> : m.name[0]}
                                                            </button>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* å¸«å‚…æ¬„ä½ */}
                                <div className="lg:col-span-9 overflow-x-auto pb-4">
                                    <div className="flex gap-4 min-w-full h-full">
                                        {masters.map(m => {
                                            const tasks = getTasks(m.id);
                                            return (
                                                <div key={m.id} className="flex-1 min-w-[260px] bg-white rounded-[2rem] shadow-lg border border-slate-100 h-[800px] flex flex-col overflow-hidden">
                                                    <div className="p-5 border-b border-slate-100 bg-slate-50/50">
                                                        <div className="flex justify-between items-center mb-3">
                                                            <div className="flex items-center gap-3">
                                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shadow-md ${m.color.split(' ')[0]}`}>{m.name[0]}</div>
                                                                <div>
                                                                    <div className="font-bold text-slate-800">{m.name}</div>
                                                                    <div className="text-[10px] text-slate-400">{m.skill}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <button onClick={() => openMapRoute(m.id)} className="w-full bg-white hover:bg-indigo-50 text-slate-700 hover:text-indigo-600 text-xs font-bold py-2.5 rounded-xl border border-slate-200 flex items-center justify-center gap-2 transition-all active:scale-95">
                                                            <Icons.Map /> å…¨æ—¥è·¯ç·šå°èˆª
                                                        </button>
                                                    </div>
                                                    <div className="p-3 space-y-3 overflow-y-auto flex-1 bg-slate-50/30">
                                                        {tasks.map(t => (
                                                            <div key={t.id} className={`bg-white p-4 rounded-2xl border shadow-sm relative group card-anim ${t.isFixed ? 'border-rose-200 ring-1 ring-rose-100' : 'border-slate-100'}`}>
                                                                <div className="flex justify-between text-xs text-slate-400 mb-2 border-b border-slate-50 pb-2">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="font-bold text-indigo-600">{t.period || 'å…¨å¤©'}</span>
                                                                        <button onClick={() => toggleLock(t.id, t.isFixed)} className={`transition-colors ${t.isFixed ? 'text-rose-500' : 'text-slate-300 hover:text-slate-500'}`} title={t.isFixed ? "æ€¥ä»¶é–å®šä¸­" : "é»æ“Šé–å®š"}>
                                                                            {t.isFixed ? <Icons.Lock/> : <Icons.Unlock/>}
                                                                        </button>
                                                                    </div>
                                                                    <button onClick={()=>removeAssign(t.id)} className="text-slate-300 hover:text-rose-500 transition-colors opacity-0 group-hover:opacity-100"><Icons.X/></button>
                                                                </div>
                                                                <div className="font-bold text-slate-800 text-sm mb-1">{t.project.name}</div>
                                                                <div className="text-xs text-slate-500 flex items-start gap-1">
                                                                    <span className="mt-0.5 text-slate-300"><Icons.Map /></span> <span className="line-clamp-1">{t.project.address || t.project.region}</span>
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {tasks.length === 0 && (
                                                            <div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-60 space-y-2">
                                                                <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-xl">ğŸ’¤</div>
                                                                <span className="text-xs font-bold">ç„¡è¡Œç¨‹</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* æ™ºæ…§æ’ç¨‹ */}
                    {view === 'smart' && (
                        <div className="bg-slate-900 rounded-[2.5rem] shadow-2xl p-8 lg:p-12 text-white card-anim relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-indigo-600/20 rounded-full blur-[100px] -mr-20 -mt-20"></div>
                            
                            <div className="relative z-10 grid grid-cols-1 lg:grid-cols-2 gap-12">
                                <div className="space-y-6">
                                    <div>
                                        <div className="flex items-center gap-3 mb-2 text-indigo-400">
                                            <Icons.Robot /> <span className="text-sm font-bold uppercase tracking-widest">AI Scheduling</span>
                                        </div>
                                        <h2 className="text-3xl font-bold tracking-tight">æ™ºæ…§æ’ç¨‹ä¸­å¿ƒ</h2>
                                        <p className="text-slate-400 text-sm mt-2">è²¼ä¸Šå»ºæ¡ˆè³‡æ–™ï¼Œç³»çµ±å°‡è‡ªå‹•åˆ†æå€åŸŸèˆ‡åœ°å€ï¼Œä¸¦è¨ˆç®—æœ€ä½³åˆ†é…ã€‚</p>
                                    </div>
                                    
                                    <div className="bg-slate-800/50 p-6 rounded-3xl border border-slate-700/50 backdrop-blur-sm">
                                        <label className="text-xs font-bold text-slate-400 mb-3 block uppercase">è³‡æ–™è¼¸å…¥å€</label>
                                        <textarea 
                                            className="w-full h-64 bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-sm text-slate-200 font-mono focus:ring-2 focus:ring-indigo-500/50 outline-none transition-all placeholder-slate-600"
                                            placeholder="ç¯„ä¾‹æ ¼å¼ï¼š&#10;å¸å¯¶æ¡ˆ, å¤§å®‰å€, ä»æ„›è·¯ä¸‰æ®µ53è™Ÿ, é™³å¸«å‚…&#10;ä¿¡ç¾©A13, ä¿¡ç¾©å€, æ¾ä»è·¯58è™Ÿ"
                                            value={importText}
                                            onChange={e => setImportText(e.target.value)}
                                        ></textarea>
                                        <button onClick={parseTasks} className="w-full mt-4 bg-indigo-600 text-white font-bold py-4 rounded-xl hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-900/50">
                                            1. åˆ†æè³‡æ–™
                                        </button>
                                    </div>
                                </div>

                                <div className="flex flex-col h-full bg-slate-800/30 rounded-[2rem] border border-slate-700/50 p-6">
                                    <div className="flex-1 overflow-y-auto mb-6 pr-2">
                                        {parsedTasks.length === 0 ? (
                                            <div className="h-full flex flex-col items-center justify-center text-slate-600 space-y-3">
                                                <div className="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center text-2xl">ğŸ“Š</div>
                                                <span className="text-sm font-medium">ç­‰å¾…åˆ†æ...</span>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                {parsedTasks.map((t, idx) => (
                                                    <div key={idx} className="bg-slate-800 p-4 rounded-2xl flex justify-between items-center border border-slate-700">
                                                        <div>
                                                            <div className="font-bold text-sm text-white">{t.name}</div>
                                                            <div className="text-xs text-slate-500 mt-1">{t.address || t.region}</div>
                                                        </div>
                                                        <div className="flex flex-col items-end gap-1">
                                                            <span className={`region-tag ${getRegionStyles(t.region).replace('bg-', 'text-').replace('border-', 'border-slate-600 ')}`}>{t.region}</span>
                                                            {t.targetMaster ? (
                                                                <span className="text-[10px] text-indigo-400 font-bold bg-indigo-900/30 px-2 py-0.5 rounded">æŒ‡å®šï¼š{t.targetMaster.name}</span>
                                                            ) : (
                                                                <span className="text-[10px] text-slate-500">è‡ªå‹•</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                                        <div className="mb-4">
                                            <label className="text-[10px] font-bold text-slate-500 uppercase block mb-2">æ’ç¨‹èµ·å§‹æ—¥</label>
                                            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full bg-slate-900 border border-slate-600 text-white p-3 rounded-xl font-bold outline-none focus:border-indigo-500"/>
                                        </div>
                                        <label className="flex items-center gap-3 cursor-pointer p-2 mb-4 hover:bg-slate-700/50 rounded-lg transition-colors">
                                            <input type="checkbox" checked={replanExisting} onChange={e=>setReplanExisting(e.target.checked)} className="w-5 h-5 rounded text-indigo-500 bg-slate-900 border-slate-600 focus:ring-0" />
                                            <span className="text-sm text-slate-300">é‡æ’æœªä¾†è¡Œç¨‹ <span className="text-xs text-rose-400 ml-1">(é–å®šè¡Œç¨‹å°‡è¢«ä¿ç•™)</span></span>
                                        </label>
                                        <button 
                                            onClick={executeSchedule}
                                            disabled={parsedTasks.length === 0 || isProcessing}
                                            className={`w-full py-4 rounded-xl font-bold text-white shadow-xl transition-all ${isProcessing ? 'bg-slate-700' : 'bg-gradient-to-r from-indigo-600 to-blue-600 hover:scale-[1.02]'}`}
                                        >
                                            {isProcessing ? "AI è¨ˆç®—ä¸­..." : "2. åŸ·è¡Œæ™ºæ…§æ’ç¨‹"}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* å»ºæ¡ˆåº« */}
                    {view === 'projects' && (
                        <div className="bg-white rounded-[2.5rem] shadow-xl border border-slate-100 p-8 card-anim">
                            <div className="flex justify-between items-center mb-8">
                                <h2 className="text-2xl font-bold text-slate-800">ğŸ“‚ å»ºæ¡ˆè³‡æ–™åº«</h2>
                                <button onClick={()=>setIsFormOpen(true)} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition-all flex items-center gap-2">
                                    <Icons.Plus /> æ–°å¢å»ºæ¡ˆ
                                </button>
                            </div>
                            
                            {isFormOpen && (
                                <div className="mb-8 p-6 bg-slate-50 rounded-3xl border border-slate-200 grid grid-cols-1 md:grid-cols-5 gap-4 card-anim">
                                    <input placeholder="å»ºæ¡ˆåç¨±" className="p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold" value={newProject.name} onChange={e=>setNewProject({...newProject, name:e.target.value})} />
                                    <input placeholder="å€åŸŸ" className="p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold" value={newProject.region} onChange={e=>setNewProject({...newProject, region:e.target.value})} />
                                    <input placeholder="åœ°å€" className="p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold" value={newProject.address} onChange={e=>setNewProject({...newProject, address:e.target.value})} />
                                    <input placeholder="å‚™è¨»" className="p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold" value={newProject.note} onChange={e=>setNewProject({...newProject, note:e.target.value})} />
                                    <div className="flex gap-2">
                                        <button onClick={addProject} className="flex-1 bg-indigo-600 text-white rounded-xl font-bold shadow-md hover:bg-indigo-500">å„²å­˜</button>
                                        <button onClick={()=>setIsFormOpen(false)} className="px-4 bg-white border border-slate-300 rounded-xl text-slate-500 font-bold hover:bg-slate-100">å–æ¶ˆ</button>
                                    </div>
                                </div>
                            )}

                            <div className="overflow-hidden rounded-2xl border border-slate-100">
                                <table className="w-full text-left">
                                    <thead className="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider font-bold">
                                        <tr><th className="p-4">å€åŸŸ</th><th className="p-4">å»ºæ¡ˆå</th><th className="p-4">åœ°å€</th><th className="p-4">å‚™è¨»</th><th className="p-4 text-center">åˆªé™¤</th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {projects.map(p => (
                                            <tr key={p.id} className="hover:bg-slate-50/80 transition-colors">
                                                <td className="p-4 w-32"><EditableInput className={`region-tag w-full text-center ${getRegionStyles(p.region)}`} value={p.region} onSave={v=>updateProject(p.id, 'region', v)} /></td>
                                                <td className="p-4 font-bold text-slate-800"><EditableInput className="w-full border-none p-1 focus:bg-white rounded" value={p.name} onSave={v=>updateProject(p.id, 'name', v)} /></td>
                                                <td className="p-4 text-sm text-slate-500"><EditableInput className="w-full border-none p-1 focus:bg-white rounded" value={p.address} onSave={v=>updateProject(p.id, 'address', v)} /></td>
                                                <td className="p-4 text-sm text-slate-400"><EditableInput className="w-full border-none p-1 focus:bg-white rounded" value={p.note} onSave={v=>updateProject(p.id, 'note', v)} /></td>
                                                <td className="p-4 text-center"><button onClick={()=>deleteProject(p.id)} className="text-slate-300 hover:text-rose-500 transition-colors p-2 hover:bg-rose-50 rounded-lg"><Icons.Trash/></button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* å¸«å‚…è¨­å®š */}
                    {view === 'settings' && (
                        <div className="max-w-4xl mx-auto">
                            <div className="text-center mb-10">
                                <h2 className="text-3xl font-bold text-slate-800">å¸«å‚…ç®¡ç†èˆ‡åˆ†äº«</h2>
                                <p className="text-slate-400 mt-2">é»æ“Šä¸‹æ–¹å¡ç‰‡æŒ‰éˆ•ï¼Œè¤‡è£½å°ˆå±¬è¡Œç¨‹ç¶²å€å‚³é€çµ¦å¸«å‚…</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {masters.map(m => (
                                    <div key={m.id} className="bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100 flex items-center gap-6 card-anim">
                                        <div className={`w-20 h-20 rounded-full flex items-center justify-center text-3xl text-white font-bold shadow-lg ${m.color.split(' ')[0]}`}>
                                            {m.name[0]}
                                        </div>
                                        <div className="flex-1">
                                            <EditableInput className="text-2xl font-bold text-slate-800 w-full mb-1" value={m.name} onSave={v=>updateMaster(m.id, 'name', v)} />
                                            <EditableInput className="text-sm font-bold text-slate-400 uppercase tracking-wider w-full mb-4" value={m.skill} onSave={v=>updateMaster(m.id, 'skill', v)} />
                                            <button onClick={() => copyShareLink(m.name)} className="text-xs font-bold text-white bg-slate-900 px-4 py-2 rounded-full flex items-center gap-2 hover:bg-indigo-600 transition-colors shadow-md">
                                                <Icons.Share /> è¤‡è£½é€£çµ
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
